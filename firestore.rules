
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Reglas para la colección 'materials'
    match /materials/{materialId} {
      // Cualquier usuario puede leer los detalles de un artículo individual.
      allow get: if true;
      
      // Solo el administrador puede crear nuevos artículos.
      allow create: if request.auth != null && request.auth.token.email == 'jhelenandreat@gmail.com';
      
      // Se permite actualizar si el usuario es el dueño, O si la actualización es para solicitar un artículo.
      allow update: if (request.auth != null && request.auth.token.email == 'jhelenandreat@gmail.com') || 
                      (request.resource.data.solicitudes == resource.data.solicitudes + 1);

      // Solo el administrador puede eliminar artículos.
      allow delete: if request.auth != null && request.auth.token.email == 'jhelenandreat@gmail.com';
      
      // Solo el administrador puede listar todos los artículos.
      allow list: if request.auth != null && request.auth.token.email == 'jhelenandreat@gmail.com';

      // Reglas para la subcolección 'requests'
      match /requests/{requestId} {
        // Cualquiera puede crear una solicitud para un artículo.
        allow create: if true;
        
        // Solo el dueño del material (el admin) puede leer las solicitudes.
        allow read: if get(/databases/$(database)/documents/materials/$(materialId)).data.postedBy == request.auth.uid;
        
        // Nadie puede actualizar o eliminar solicitudes directamente.
        allow update, delete: if false;
      }
    }

    // Reglas para la colección 'users'
    match /users/{userId} {
      // Un usuario solo puede leer y escribir su propio documento.
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
